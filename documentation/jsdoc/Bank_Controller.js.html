

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Bank/Controller.js | Companion</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 147px; height: 24px">
        
            <a href="https://bitfocus.io" rel="noopener noreferrer" target="_blank">
                <img src="https://bitfocus.io/images/topbar-logowhite.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Companion</a></h1>
        
            <span class="version">v2.3.0</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="BankActionController.html">BankActionController</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankActionController_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankActionController.html#actions">actions</a></li><li><a href="BankActionController.html#actionsRunning">actionsRunning</a></li><li><a href="BankActionController.html#bank">bank</a></li><li><a href="BankActionController.html#bankStatus">bankStatus</a></li><li><a href="BankActionController.html#config">config</a></li><li><a href="BankActionController.html#db">db</a></li><li><a href="BankActionController.html#debug">debug</a></li><li><a href="BankActionController.html#definitions">definitions</a></li><li><a href="BankActionController.html#deviceController">deviceController</a></li><li><a href="BankActionController.html#graphics">graphics</a></li><li><a href="BankActionController.html#instance">instance</a></li><li><a href="BankActionController.html#io">io</a></li><li><a href="BankActionController.html#logSource">logSource</a></li><li><a href="BankActionController.html#page">page</a></li><li><a href="BankActionController.html#.PageStyles">PageStyles</a></li><li><a href="BankActionController.html#registry">registry</a></li><li><a href="BankActionController.html#releaseActions">releaseActions</a></li><li><a href="BankActionController.html#schedule">schedule</a></li><li><a href="BankActionController.html#services">services</a></li><li><a href="BankActionController.html#skipNext">skipNext</a></li><li><a href="BankActionController.html#skipUp">skipUp</a></li><li><a href="BankActionController.html#system">system</a></li><li><a href="BankActionController.html#timersRunning">timersRunning</a></li><li><a href="BankActionController.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankActionController.html#log">log</a></li></ul></div></li><li><a href="BankActionDefinition.html">BankActionDefinition</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankActionDefinition_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankActionDefinition.html#label">label</a></li><li><a href="BankActionDefinition.html#options">options</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankActionDefinition.html#callback">callback</a></li><li><a href="BankActionDefinition.html#subscribe">subscribe</a></li><li><a href="BankActionDefinition.html#unsubscribe">unsubscribe</a></li></ul></div></li><li><a href="BankActionItems.html">BankActionItems</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankActionItems_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankActionItems.html#bank">bank</a></li><li><a href="BankActionItems.html#config">config</a></li><li><a href="BankActionItems.html#controller">controller</a></li><li><a href="BankActionItems.html#db">db</a></li><li><a href="BankActionItems.html#dbKey">dbKey</a></li><li><a href="BankActionItems.html#debug">debug</a></li><li><a href="BankActionItems.html#definitions">definitions</a></li><li><a href="BankActionItems.html#deviceController">deviceController</a></li><li><a href="BankActionItems.html#graphics">graphics</a></li><li><a href="BankActionItems.html#instance">instance</a></li><li><a href="BankActionItems.html#io">io</a></li><li><a href="BankActionItems.html#items">items</a></li><li><a href="BankActionItems.html#logSource">logSource</a></li><li><a href="BankActionItems.html#page">page</a></li><li><a href="BankActionItems.html#registry">registry</a></li><li><a href="BankActionItems.html#schedule">schedule</a></li><li><a href="BankActionItems.html#services">services</a></li><li><a href="BankActionItems.html#system">system</a></li><li><a href="BankActionItems.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankActionItems.html#addItem">addItem</a></li><li><a href="BankActionItems.html#addItemByClient">addItemByClient</a></li><li><a href="BankActionItems.html#checkBankExists">checkBankExists</a></li><li><a href="BankActionItems.html#checkBankStatus">checkBankStatus</a></li><li><a href="BankActionItems.html#checkInstanceStatus">checkInstanceStatus</a></li><li><a href="BankActionItems.html#checkStatus">checkStatus</a></li><li><a href="BankActionItems.html#cleanupItems">cleanupItems</a></li><li><a href="BankActionItems.html#deleteInstance">deleteInstance</a></li><li><a href="BankActionItems.html#deleteItem">deleteItem</a></li><li><a href="BankActionItems.html#deleteItemByClient">deleteItemByClient</a></li><li><a href="BankActionItems.html#getAll">getAll</a></li><li><a href="BankActionItems.html#getBank">getBank</a></li><li><a href="BankActionItems.html#getBankByClient">getBankByClient</a></li><li><a href="BankActionItems.html#getInstanceItems">getInstanceItems</a></li><li><a href="BankActionItems.html#getPage">getPage</a></li><li><a href="BankActionItems.html#importBank">importBank</a></li><li><a href="BankActionItems.html#log">log</a></li><li><a href="BankActionItems.html#resetBank">resetBank</a></li><li><a href="BankActionItems.html#save">save</a></li><li><a href="BankActionItems.html#setDefinitions">setDefinitions</a></li><li><a href="BankActionItems.html#subscribe">subscribe</a></li><li><a href="BankActionItems.html#subscribeBank">subscribeBank</a></li><li><a href="BankActionItems.html#unsubscribe">unsubscribe</a></li><li><a href="BankActionItems.html#unsubscribeBank">unsubscribeBank</a></li><li><a href="BankActionItems.html#updateItemDelay">updateItemDelay</a></li><li><a href="BankActionItems.html#updateItemOption">updateItemOption</a></li><li><a href="BankActionItems.html#updateItemOrder">updateItemOrder</a></li></ul></div></li><li><a href="BankController.html">BankController</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankController_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankController.html#actions">actions</a></li><li><a href="BankController.html#bank">bank</a></li><li><a href="BankController.html#config">config</a></li><li><a href="BankController.html#db">db</a></li><li><a href="BankController.html#debug">debug</a></li><li><a href="BankController.html#deviceController">deviceController</a></li><li><a href="BankController.html#feedback">feedback</a></li><li><a href="BankController.html#fields">fields</a></li><li><a href="BankController.html#graphics">graphics</a></li><li><a href="BankController.html#instance">instance</a></li><li><a href="BankController.html#io">io</a></li><li><a href="BankController.html#logSource">logSource</a></li><li><a href="BankController.html#page">page</a></li><li><a href="BankController.html#registry">registry</a></li><li><a href="BankController.html#schedule">schedule</a></li><li><a href="BankController.html#services">services</a></li><li><a href="BankController.html#system">system</a></li><li><a href="BankController.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankController.html#log">log</a></li></ul></div></li><li><a href="BankFeedbackController.html">BankFeedbackController</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankFeedbackController_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankFeedbackController.html#bank">bank</a></li><li><a href="BankFeedbackController.html#config">config</a></li><li><a href="BankFeedbackController.html#db">db</a></li><li><a href="BankFeedbackController.html#debug">debug</a></li><li><a href="BankFeedbackController.html#deviceController">deviceController</a></li><li><a href="BankFeedbackController.html#graphics">graphics</a></li><li><a href="BankFeedbackController.html#instance">instance</a></li><li><a href="BankFeedbackController.html#io">io</a></li><li><a href="BankFeedbackController.html#logSource">logSource</a></li><li><a href="BankFeedbackController.html#page">page</a></li><li><a href="BankFeedbackController.html#registry">registry</a></li><li><a href="BankFeedbackController.html#schedule">schedule</a></li><li><a href="BankFeedbackController.html#services">services</a></li><li><a href="BankFeedbackController.html#system">system</a></li><li><a href="BankFeedbackController.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankFeedbackController.html#log">log</a></li></ul></div></li><li><a href="BankFeedbackDefinition.html">BankFeedbackDefinition</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankFeedbackDefinition_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankFeedbackDefinition.html#description">description</a></li><li><a href="BankFeedbackDefinition.html#label">label</a></li><li><a href="BankFeedbackDefinition.html#options">options</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankFeedbackDefinition.html#callback">callback</a></li><li><a href="BankFeedbackDefinition.html#subscribe">subscribe</a></li><li><a href="BankFeedbackDefinition.html#unsubscribe">unsubscribe</a></li></ul></div></li><li><a href="BankFeedbackItems.html">BankFeedbackItems</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankFeedbackItems_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankFeedbackItems.html#bank">bank</a></li><li><a href="BankFeedbackItems.html#config">config</a></li><li><a href="BankFeedbackItems.html#controller">controller</a></li><li><a href="BankFeedbackItems.html#db">db</a></li><li><a href="BankFeedbackItems.html#dbKey">dbKey</a></li><li><a href="BankFeedbackItems.html#debug">debug</a></li><li><a href="BankFeedbackItems.html#definitions">definitions</a></li><li><a href="BankFeedbackItems.html#deviceController">deviceController</a></li><li><a href="BankFeedbackItems.html#graphics">graphics</a></li><li><a href="BankFeedbackItems.html#instance">instance</a></li><li><a href="BankFeedbackItems.html#io">io</a></li><li><a href="BankFeedbackItems.html#items">items</a></li><li><a href="BankFeedbackItems.html#logSource">logSource</a></li><li><a href="BankFeedbackItems.html#page">page</a></li><li><a href="BankFeedbackItems.html#registry">registry</a></li><li><a href="BankFeedbackItems.html#schedule">schedule</a></li><li><a href="BankFeedbackItems.html#services">services</a></li><li><a href="BankFeedbackItems.html#system">system</a></li><li><a href="BankFeedbackItems.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankFeedbackItems.html#addItem">addItem</a></li><li><a href="BankFeedbackItems.html#addItemByClient">addItemByClient</a></li><li><a href="BankFeedbackItems.html#checkBankExists">checkBankExists</a></li><li><a href="BankFeedbackItems.html#checkBankStatus">checkBankStatus</a></li><li><a href="BankFeedbackItems.html#checkInstanceStatus">checkInstanceStatus</a></li><li><a href="BankFeedbackItems.html#checkStatus">checkStatus</a></li><li><a href="BankFeedbackItems.html#cleanupItems">cleanupItems</a></li><li><a href="BankFeedbackItems.html#deleteInstance">deleteInstance</a></li><li><a href="BankFeedbackItems.html#deleteItem">deleteItem</a></li><li><a href="BankFeedbackItems.html#deleteItemByClient">deleteItemByClient</a></li><li><a href="BankFeedbackItems.html#getAll">getAll</a></li><li><a href="BankFeedbackItems.html#getBank">getBank</a></li><li><a href="BankFeedbackItems.html#getBankByClient">getBankByClient</a></li><li><a href="BankFeedbackItems.html#getBankStyles">getBankStyles</a></li><li><a href="BankFeedbackItems.html#getInstanceItems">getInstanceItems</a></li><li><a href="BankFeedbackItems.html#getPage">getPage</a></li><li><a href="BankFeedbackItems.html#getStyle">getStyle</a></li><li><a href="BankFeedbackItems.html#importBank">importBank</a></li><li><a href="BankFeedbackItems.html#log">log</a></li><li><a href="BankFeedbackItems.html#resetBank">resetBank</a></li><li><a href="BankFeedbackItems.html#save">save</a></li><li><a href="BankFeedbackItems.html#setDefinitions">setDefinitions</a></li><li><a href="BankFeedbackItems.html#setStyle">setStyle</a></li><li><a href="BankFeedbackItems.html#subscribe">subscribe</a></li><li><a href="BankFeedbackItems.html#subscribeBank">subscribeBank</a></li><li><a href="BankFeedbackItems.html#unsubscribe">unsubscribe</a></li><li><a href="BankFeedbackItems.html#unsubscribeBank">unsubscribeBank</a></li><li><a href="BankFeedbackItems.html#updateItemOption">updateItemOption</a></li><li><a href="BankFeedbackItems.html#updateItemOrder">updateItemOrder</a></li></ul></div></li><li><a href="BankItemDefinition.html">BankItemDefinition</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankItemDefinition_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankItemDefinition.html#label">label</a></li><li><a href="BankItemDefinition.html#options">options</a></li></ul></div></li><li><a href="BankItemsBase.html">BankItemsBase</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankItemsBase_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankItemsBase.html#bank">bank</a></li><li><a href="BankItemsBase.html#config">config</a></li><li><a href="BankItemsBase.html#controller">controller</a></li><li><a href="BankItemsBase.html#db">db</a></li><li><a href="BankItemsBase.html#dbKey">dbKey</a></li><li><a href="BankItemsBase.html#definitions">definitions</a></li><li><a href="BankItemsBase.html#deviceController">deviceController</a></li><li><a href="BankItemsBase.html#graphics">graphics</a></li><li><a href="BankItemsBase.html#instance">instance</a></li><li><a href="BankItemsBase.html#io">io</a></li><li><a href="BankItemsBase.html#items">items</a></li><li><a href="BankItemsBase.html#logSource">logSource</a></li><li><a href="BankItemsBase.html#page">page</a></li><li><a href="BankItemsBase.html#registry">registry</a></li><li><a href="BankItemsBase.html#schedule">schedule</a></li><li><a href="BankItemsBase.html#services">services</a></li><li><a href="BankItemsBase.html#system">system</a></li><li><a href="BankItemsBase.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="BankItemsBase.html#addItem">addItem</a></li><li><a href="BankItemsBase.html#addItemByClient">addItemByClient</a></li><li><a href="BankItemsBase.html#checkBankExists">checkBankExists</a></li><li><a href="BankItemsBase.html#checkInstanceStatus">checkInstanceStatus</a></li><li><a href="BankItemsBase.html#checkStatus">checkStatus</a></li><li><a href="BankItemsBase.html#cleanupItems">cleanupItems</a></li><li><a href="BankItemsBase.html#deleteInstance">deleteInstance</a></li><li><a href="BankItemsBase.html#deleteItem">deleteItem</a></li><li><a href="BankItemsBase.html#deleteItemByClient">deleteItemByClient</a></li><li><a href="BankItemsBase.html#getAll">getAll</a></li><li><a href="BankItemsBase.html#getBank">getBank</a></li><li><a href="BankItemsBase.html#getBankByClient">getBankByClient</a></li><li><a href="BankItemsBase.html#getInstanceItems">getInstanceItems</a></li><li><a href="BankItemsBase.html#getPage">getPage</a></li><li><a href="BankItemsBase.html#importBank">importBank</a></li><li><a href="BankItemsBase.html#log">log</a></li><li><a href="BankItemsBase.html#resetBank">resetBank</a></li><li><a href="BankItemsBase.html#save">save</a></li><li><a href="BankItemsBase.html#setDefinitions">setDefinitions</a></li><li><a href="BankItemsBase.html#subscribe">subscribe</a></li><li><a href="BankItemsBase.html#subscribeBank">subscribeBank</a></li><li><a href="BankItemsBase.html#unsubscribe">unsubscribe</a></li><li><a href="BankItemsBase.html#unsubscribeBank">unsubscribeBank</a></li><li><a href="BankItemsBase.html#updateItemOption">updateItemOption</a></li><li><a href="BankItemsBase.html#updateItemOrder">updateItemOrder</a></li></ul></div></li><li><a href="BankStyle.html">BankStyle</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BankStyle_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="BankStyle.html#alignment">alignment</a></li><li><a href="BankStyle.html#base64">base64</a></li><li><a href="BankStyle.html#bgcolor">bgcolor</a></li><li><a href="BankStyle.html#color">color</a></li><li><a href="BankStyle.html#png64">png64</a></li><li><a href="BankStyle.html#pngalignment">pngalignment</a></li><li><a href="BankStyle.html#size">size</a></li><li><a href="BankStyle.html#text">text</a></li></ul></div></li><li><a href="Config.html">Config</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Config_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Config.html#bank">bank</a></li><li><a href="Config.html#cfgBakFile">cfgBakFile</a></li><li><a href="Config.html#cfgCorruptFile">cfgCorruptFile</a></li><li><a href="Config.html#cfgDir">cfgDir</a></li><li><a href="Config.html#cfgFile">cfgFile</a></li><li><a href="Config.html#cfgTmpFile">cfgTmpFile</a></li><li><a href="Config.html#config">config</a></li><li><a href="Config.html#db">db</a></li><li><a href="Config.html#debug">debug</a></li><li><a href="Config.html#defaults">defaults</a></li><li><a href="Config.html#deviceController">deviceController</a></li><li><a href="Config.html#dirty">dirty</a></li><li><a href="Config.html#graphics">graphics</a></li><li><a href="Config.html#instance">instance</a></li><li><a href="Config.html#io">io</a></li><li><a href="Config.html#lastsave">lastsave</a></li><li><a href="Config.html#logSource">logSource</a></li><li><a href="Config.html#name">name</a></li><li><a href="Config.html#page">page</a></li><li><a href="Config.html#registry">registry</a></li><li><a href="Config.html#.SaveCycle">SaveCycle</a></li><li><a href="Config.html#saveCycle">saveCycle</a></li><li><a href="Config.html#saveInterval">saveInterval</a></li><li><a href="Config.html#saving">saving</a></li><li><a href="Config.html#schedule">schedule</a></li><li><a href="Config.html#services">services</a></li><li><a href="Config.html#store">store</a></li><li><a href="Config.html#system">system</a></li><li><a href="Config.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Config.html#deleteKey">deleteKey</a></li><li><a href="Config.html#doSave">doSave</a></li><li><a href="Config.html#getAll">getAll</a></li><li><a href="Config.html#getKey">getKey</a></li><li><a href="Config.html#loadBackupSync">loadBackupSync</a></li><li><a href="Config.html#loadDefaults">loadDefaults</a></li><li><a href="Config.html#loadSync">loadSync</a></li><li><a href="Config.html#log">log</a></li><li><a href="Config.html#save">save</a></li><li><a href="Config.html#saveImmediate">saveImmediate</a></li><li><a href="Config.html#setDirty">setDirty</a></li><li><a href="Config.html#setKey">setKey</a></li><li><a href="Config.html#setKeys">setKeys</a></li><li><a href="Config.html#setSaveCycle">setSaveCycle</a></li></ul></div></li><li><a href="CoreBase.html">CoreBase</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CoreBase_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="CoreBase.html#bank">bank</a></li><li><a href="CoreBase.html#config">config</a></li><li><a href="CoreBase.html#db">db</a></li><li><a href="CoreBase.html#deviceController">deviceController</a></li><li><a href="CoreBase.html#graphics">graphics</a></li><li><a href="CoreBase.html#instance">instance</a></li><li><a href="CoreBase.html#io">io</a></li><li><a href="CoreBase.html#logSource">logSource</a></li><li><a href="CoreBase.html#page">page</a></li><li><a href="CoreBase.html#registry">registry</a></li><li><a href="CoreBase.html#schedule">schedule</a></li><li><a href="CoreBase.html#services">services</a></li><li><a href="CoreBase.html#system">system</a></li><li><a href="CoreBase.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="CoreBase.html#log">log</a></li></ul></div></li><li><a href="Database.html">Database</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Database_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Database.html#bank">bank</a></li><li><a href="Database.html#cfgBakFile">cfgBakFile</a></li><li><a href="Database.html#cfgCorruptFile">cfgCorruptFile</a></li><li><a href="Database.html#cfgDir">cfgDir</a></li><li><a href="Database.html#cfgFile">cfgFile</a></li><li><a href="Database.html#cfgTmpFile">cfgTmpFile</a></li><li><a href="Database.html#config">config</a></li><li><a href="Database.html#db">db</a></li><li><a href="Database.html#debug">debug</a></li><li><a href="Database.html#defaults">defaults</a></li><li><a href="Database.html#deviceController">deviceController</a></li><li><a href="Database.html#dirty">dirty</a></li><li><a href="Database.html#graphics">graphics</a></li><li><a href="Database.html#instance">instance</a></li><li><a href="Database.html#io">io</a></li><li><a href="Database.html#lastsave">lastsave</a></li><li><a href="Database.html#logSource">logSource</a></li><li><a href="Database.html#name">name</a></li><li><a href="Database.html#page">page</a></li><li><a href="Database.html#registry">registry</a></li><li><a href="Database.html#.SaveCycle">SaveCycle</a></li><li><a href="Database.html#saveCycle">saveCycle</a></li><li><a href="Database.html#saveInterval">saveInterval</a></li><li><a href="Database.html#saving">saving</a></li><li><a href="Database.html#schedule">schedule</a></li><li><a href="Database.html#services">services</a></li><li><a href="Database.html#store">store</a></li><li><a href="Database.html#system">system</a></li><li><a href="Database.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Database.html#deleteKey">deleteKey</a></li><li><a href="Database.html#doSave">doSave</a></li><li><a href="Database.html#getAll">getAll</a></li><li><a href="Database.html#getKey">getKey</a></li><li><a href="Database.html#loadBackupSync">loadBackupSync</a></li><li><a href="Database.html#loadDefaults">loadDefaults</a></li><li><a href="Database.html#loadSync">loadSync</a></li><li><a href="Database.html#log">log</a></li><li><a href="Database.html#save">save</a></li><li><a href="Database.html#saveImmediate">saveImmediate</a></li><li><a href="Database.html#setDirty">setDirty</a></li><li><a href="Database.html#setKey">setKey</a></li><li><a href="Database.html#setKeys">setKeys</a></li><li><a href="Database.html#setSaveCycle">setSaveCycle</a></li></ul></div></li><li><a href="DataStoreBase.html">DataStoreBase</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DataStoreBase_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="DataStoreBase.html#bank">bank</a></li><li><a href="DataStoreBase.html#cfgBakFile">cfgBakFile</a></li><li><a href="DataStoreBase.html#cfgCorruptFile">cfgCorruptFile</a></li><li><a href="DataStoreBase.html#cfgDir">cfgDir</a></li><li><a href="DataStoreBase.html#cfgFile">cfgFile</a></li><li><a href="DataStoreBase.html#cfgTmpFile">cfgTmpFile</a></li><li><a href="DataStoreBase.html#config">config</a></li><li><a href="DataStoreBase.html#db">db</a></li><li><a href="DataStoreBase.html#defaults">defaults</a></li><li><a href="DataStoreBase.html#deviceController">deviceController</a></li><li><a href="DataStoreBase.html#dirty">dirty</a></li><li><a href="DataStoreBase.html#graphics">graphics</a></li><li><a href="DataStoreBase.html#instance">instance</a></li><li><a href="DataStoreBase.html#io">io</a></li><li><a href="DataStoreBase.html#lastsave">lastsave</a></li><li><a href="DataStoreBase.html#logSource">logSource</a></li><li><a href="DataStoreBase.html#name">name</a></li><li><a href="DataStoreBase.html#page">page</a></li><li><a href="DataStoreBase.html#registry">registry</a></li><li><a href="DataStoreBase.html#saveCycle">saveCycle</a></li><li><a href="DataStoreBase.html#saveInterval">saveInterval</a></li><li><a href="DataStoreBase.html#saving">saving</a></li><li><a href="DataStoreBase.html#schedule">schedule</a></li><li><a href="DataStoreBase.html#services">services</a></li><li><a href="DataStoreBase.html#store">store</a></li><li><a href="DataStoreBase.html#system">system</a></li><li><a href="DataStoreBase.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="DataStoreBase.html#deleteKey">deleteKey</a></li><li><a href="DataStoreBase.html#doSave">doSave</a></li><li><a href="DataStoreBase.html#getAll">getAll</a></li><li><a href="DataStoreBase.html#getKey">getKey</a></li><li><a href="DataStoreBase.html#loadBackupSync">loadBackupSync</a></li><li><a href="DataStoreBase.html#loadDefaults">loadDefaults</a></li><li><a href="DataStoreBase.html#loadSync">loadSync</a></li><li><a href="DataStoreBase.html#log">log</a></li><li><a href="DataStoreBase.html#save">save</a></li><li><a href="DataStoreBase.html#saveImmediate">saveImmediate</a></li><li><a href="DataStoreBase.html#setDirty">setDirty</a></li><li><a href="DataStoreBase.html#setKey">setKey</a></li><li><a href="DataStoreBase.html#setKeys">setKeys</a></li><li><a href="DataStoreBase.html#setSaveCycle">setSaveCycle</a></li></ul></div></li><li><a href="InterfaceClient.html">InterfaceClient</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="InterfaceClient_sub"><div class="member-type">Events</div><ul class="inner"><li><a href="InterfaceClient.html#~event:get_userconfig_all">get_userconfig_all</a></li><li><a href="InterfaceClient.html#~event:set_userconfig_key">set_userconfig_key</a></li><li><a href="InterfaceClient.html#~event:set_userconfig_key:result">set_userconfig_key:result</a></li></ul></div></li><li><a href="Registry.html">Registry</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Registry_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Registry.html#appRoot">appRoot</a></li><li><a href="Registry.html#bindIp">bindIp</a></li><li><a href="Registry.html#bindPort">bindPort</a></li><li><a href="Registry.html#buildNumber">buildNumber</a></li><li><a href="Registry.html#cfgDir">cfgDir</a></li><li><a href="Registry.html#debug">debug</a></li><li><a href="Registry.html#fileVersion">fileVersion</a></li><li><a href="Registry.html#logbuffer">logbuffer</a></li><li><a href="Registry.html#logwriting">logwriting</a></li><li><a href="Registry.html#pkgInfo">pkgInfo</a></li><li><a href="Registry.html#skeletonInfo">skeletonInfo</a></li><li><a href="Registry.html#startMinimised">startMinimised</a></li><li><a href="Registry.html#system">system</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Registry.html#exit">exit</a></li><li><a href="Registry.html#launch">launch</a></li><li><a href="Registry.html#quit">quit</a></li><li><a href="Registry.html#restart">restart</a></li><li><a href="Registry.html#startLogging">startLogging</a></li></ul></div></li><li><a href="ScheduleController.html">ScheduleController</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ScheduleController_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="ScheduleController.html#bank">bank</a></li><li><a href="ScheduleController.html#config">config</a></li><li><a href="ScheduleController.html#db">db</a></li><li><a href="ScheduleController.html#debug">debug</a></li><li><a href="ScheduleController.html#deviceController">deviceController</a></li><li><a href="ScheduleController.html#graphics">graphics</a></li><li><a href="ScheduleController.html#instance">instance</a></li><li><a href="ScheduleController.html#io">io</a></li><li><a href="ScheduleController.html#logSource">logSource</a></li><li><a href="ScheduleController.html#page">page</a></li><li><a href="ScheduleController.html#registry">registry</a></li><li><a href="ScheduleController.html#schedule">schedule</a></li><li><a href="ScheduleController.html#services">services</a></li><li><a href="ScheduleController.html#system">system</a></li><li><a href="ScheduleController.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="ScheduleController.html#action">action</a></li><li><a href="ScheduleController.html#cleanConfig">cleanConfig</a></li><li><a href="ScheduleController.html#eventLoadType">eventLoadType</a></li><li><a href="ScheduleController.html#eventWatch">eventWatch</a></li><li><a href="ScheduleController.html#findEventIndex">findEventIndex</a></li><li><a href="ScheduleController.html#getBankButton">getBankButton</a></li><li><a href="ScheduleController.html#getNextId">getNextId</a></li><li><a href="ScheduleController.html#getPlugin">getPlugin</a></li><li><a href="ScheduleController.html#getSchedule">getSchedule</a></li><li><a href="ScheduleController.html#initConfig">initConfig</a></li><li><a href="ScheduleController.html#loadPlugins">loadPlugins</a></li><li><a href="ScheduleController.html#log">log</a></li><li><a href="ScheduleController.html#saveSchedule">saveSchedule</a></li><li><a href="ScheduleController.html#saveToDb">saveToDb</a></li><li><a href="ScheduleController.html#sendPlugins">sendPlugins</a></li><li><a href="ScheduleController.html#startSchedule">startSchedule</a></li><li><a href="ScheduleController.html#updateSchedule">updateSchedule</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="ScheduleController.html#~getSchedule-callback">getSchedule-callback</a></li><li><a href="ScheduleController.html#~saveSchedule-callback">saveSchedule-callback</a></li><li><a href="ScheduleController.html#~sendPlugins-callback">sendPlugins-callback</a></li><li><a href="ScheduleController.html#~updateSchedule-callback">updateSchedule-callback</a></li></ul></div></li><li><a href="SchedulePluginBase.html">SchedulePluginBase</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="SchedulePluginBase_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="SchedulePluginBase.html#multiple">multiple</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="SchedulePluginBase.html#add">add</a></li><li><a href="SchedulePluginBase.html#configDesc">configDesc</a></li><li><a href="SchedulePluginBase.html#frontEnd">frontEnd</a></li><li><a href="SchedulePluginBase.html#remove">remove</a></li><li><a href="SchedulePluginBase.html#setup">setup</a></li></ul></div></li><li><a href="ServiceBase.html">ServiceBase</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ServiceBase_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="ServiceBase.html#bank">bank</a></li><li><a href="ServiceBase.html#config">config</a></li><li><a href="ServiceBase.html#db">db</a></li><li><a href="ServiceBase.html#deviceController">deviceController</a></li><li><a href="ServiceBase.html#graphics">graphics</a></li><li><a href="ServiceBase.html#instance">instance</a></li><li><a href="ServiceBase.html#io">io</a></li><li><a href="ServiceBase.html#logSource">logSource</a></li><li><a href="ServiceBase.html#page">page</a></li><li><a href="ServiceBase.html#registry">registry</a></li><li><a href="ServiceBase.html#schedule">schedule</a></li><li><a href="ServiceBase.html#services">services</a></li><li><a href="ServiceBase.html#system">system</a></li><li><a href="ServiceBase.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="ServiceBase.html#disableModule">disableModule</a></li><li><a href="ServiceBase.html#enableModule">enableModule</a></li><li><a href="ServiceBase.html#handleSocketError">handleSocketError</a></li><li><a href="ServiceBase.html#init">init</a></li><li><a href="ServiceBase.html#log">log</a></li><li><a href="ServiceBase.html#setDefaults">setDefaults</a></li><li><a href="ServiceBase.html#updateUserconfig">updateUserconfig</a></li></ul></div></li><li><a href="UserConfig.html">UserConfig</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UserConfig_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="UserConfig.html#bank">bank</a></li><li><a href="UserConfig.html#config">config</a></li><li><a href="UserConfig.html#db">db</a></li><li><a href="UserConfig.html#debug">debug</a></li><li><a href="UserConfig.html#.Defaults">Defaults</a></li><li><a href="UserConfig.html#deviceController">deviceController</a></li><li><a href="UserConfig.html#graphics">graphics</a></li><li><a href="UserConfig.html#instance">instance</a></li><li><a href="UserConfig.html#io">io</a></li><li><a href="UserConfig.html#logSource">logSource</a></li><li><a href="UserConfig.html#page">page</a></li><li><a href="UserConfig.html#registry">registry</a></li><li><a href="UserConfig.html#schedule">schedule</a></li><li><a href="UserConfig.html#services">services</a></li><li><a href="UserConfig.html#system">system</a></li><li><a href="UserConfig.html#userconfig">userconfig</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="UserConfig.html#get">get</a></li><li><a href="UserConfig.html#getKey">getKey</a></li><li><a href="UserConfig.html#log">log</a></li><li><a href="UserConfig.html#setKey">setKey</a></li></ul></div></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const CoreBase = require('../Core/Base')
const fs = require('fs')
const { cloneDeep } = require('lodash')
const rgb = require('../Graphics/Image').rgb

const BankActionController = require('./ActionController')
const BankFeedbackController = require('./FeedbackController')

/**
 * The controller that handles all banks, including associated actions and feedbacks
 *
 * @extends CoreBase
 * @author Håkon Nessjøen &lt;haakon@bitfocus.io>
 * @author Keith Rocheck &lt;keith.rocheck@gmail.com>
 * @author William Viker &lt;william@bitfocus.io>
 * @since 1.0.4
 * @copyright 2021 Bitfocus AS
 * @license
 * This program is free software.
 * You should have received a copy of the MIT licence as well as the Bitfocus
 * Individual Contributor License Agreement for Companion along with
 * this program.
 *
 * You can be released from the requirements of the license by purchasing
 * a commercial license. Buying such a license is mandatory as soon as you
 * develop commercial activities involving the Companion software without
 * disclosing the source code of your own applications.
 */
class BankController extends CoreBase {
	static CurrentVersion = 2

	/** @type {BankActionController} */
	actions
	/** @type {Object} */
	config
	/**
	 * The debugger for this class
	 * @type {debug.Debugger}
	 * @access protected
	 */
	debug = require('debug')('Bank/Controller')
	/** @type {BankFeedbackController} */
	feedback
	/** @type {Object} */
	fields

	constructor(registry) {
		super(registry, 'bank')

		this.actions = new BankActionController(registry)
		this.feedback = new BankFeedbackController(registry)

		this.config = {}

		this.fields = {
			png: [
				{
					type: 'textinput',
					id: 'text',
					label: 'Text',
					width: 6,
					default: '',
				},
				{
					type: 'dropdown',
					id: 'size',
					label: 'Font size',
					default: 'auto',
					choices: [
						{ id: '7', label: '7pt' },
						{ id: '14', label: '14pt' },
						{ id: '18', label: '18pt' },
						{ id: '24', label: '24pt' },
						{ id: '30', label: '30pt' },
						{ id: '44', label: '44pt' },
						{ id: 'auto', label: 'Auto' },
					],
					width: 3,
				},
				{
					type: 'filepicker',
					id: 'png',
					label: '72x58 PNG',
					accept: 'image/png',
					width: 3,
					imageMinWidth: 72,
					imageMinHeight: 58,
					imageMaxWidth: 72,
					imageMaxHeight: 72,
				},
				{
					type: 'alignmentcontrol',
					id: 'alignment',
					label: 'Text Alignment',
					width: 2,
					default: 'center:center',
				},
				{
					type: 'alignmentcontrol',
					id: 'pngalignment',
					label: 'PNG Alignment',
					width: 2,
					default: 'center:center',
				},
				{
					type: 'colorpicker',
					id: 'color',
					label: 'Color',
					width: 2,
					default: rgb(255, 255, 255),
				},
				{
					type: 'colorpicker',
					id: 'bgcolor',
					label: 'Background',
					width: 2,
					default: rgb(0, 0, 0),
				},
				{
					type: 'checkbox',
					id: 'latch',
					label: 'Latch/Toggle',
					width: 2,
					default: false,
				},
				{
					type: 'checkbox',
					id: 'relative_delay',
					label: 'Relative Delays',
					width: 2,
					default: false,
				},
			],
		}

		//this.checkVersion();

		this.loadDB()

		/* Variable jiu jitsu */
		this.system.on('variable_changed', this.variableChanged.bind(this))

		//this.system.on('bank_update', this.updateConfig.bind(this));

		this.system.on('bank_set_key', this.setBankField.bind(this))

		this.system.on('bank_changefield', this.updateBankField.bind(this))

		this.system.on('import_bank', this.importBank.bind(this))

		this.system.on('io_connect', (client) => {
			this.actions.clientConnect(client)

			client.on('graphics_preview_generate', (config, id, answer) => {
				this.system.emit('graphics_preview_generate', config, (img) => {
					answer(img)
				})
			})

			client.on('bank_reset', (page, bank) => {
				this.system.emit('bank_reset', page, bank)
			})

			client.on('get_bank', (page, bank, answer) => {
				let config = this.getBank(page, bank)
				let fields = []

				if (config.style !== undefined &amp;&amp; this.fields[config.style] !== undefined) {
					fields = this.fields[config.style]
				}

				answer(page, bank, config, fields)
			})

			client.on('hot_press', (page, button, direction) => {
				this.debug('being told from gui to hot press', page, button, direction)
				this.system.emit('bank_pressed', page, button, direction)
			})

			client.on('bank_set_png', (page, bank, dataurl, answer) => {
				if (!dataurl.match(/data:.*?image\/png/)) {
					answer('error')
					return
				}

				var data = dataurl.replace(/^.*base64,/, '')
				this.config[page][bank].png64 = data
				//this.system.emit('bank_update', this.config);

				answer('ok')
				this.graphics.invalidateBank(page, bank)
			})

			client.on('bank_changefield', this.setBankField.bind(this))

			client.on('bank_clear_png', function (page, bank) {
				delete this.config[page][bank].png64
				this.system.emit('bank_update', this.config)
				this.system.emit('graphics_bank_invalidate', page, bank)
			})

			client.on('bank_copy', this.copyBank.bind(this, client))

			client.on('bank_move', this.moveBank.bind(this, client))

			client.on('bank_style', (page, bank, style, answer) => {
				this.system.emit('bank_style', page, bank, style, (fields) => {
					answer(page, bank, this.config[page][bank], fields)
				})
			})
		})

		this.system.on('bank_style', this.setBankStyle.bind(this))

		this.system.on('bank_reset', this.resetBank.bind(this))

		this.system.on('bank_rename_variables', this.renameVariables.bind(this))

		//this.system.on('bank_update_request', () => {
		//	this.system.emit('bank_update', this.config);
		//});

		this.system.on('bank_get15to32', (key, cb) => {
			cb(this.convertKey15to32(key))
		})

		this.system.on('get_banks_for_page', function (page, cb) {
			if (self.config[page] === undefined) {
				cb({})
			} else {
				cb(self.config[page])
			}
		})
	}

	copyBank(client, pagefrom, bankfrom, pageto, bankto) {
		if (pagefrom != pageto || bankfrom != bankto) {
			let exp = this.exportBank(pagefrom, bankfrom)
			this.importBank(pageto, bankto, exp)
		}

		client.emit('bank_copy:result', null, 'ok')
	}

	convertKey15to32(key) {
		var rows = Math.floor(key / 5)
		var col = (key % 5) + 1
		var res = rows * 8 + col

		if (res >= 32) {
			this.debug('assert: old config had bigger pages than expected')
			return 31
		}

		return res
	}

	exportBank(page, bank, extras = true) {
		let exp = {}

		exp.config = this.getBank(page, bank, true)

		exp.actions = this.actions.getBankActions(page, bank, true)
		exp.release_actions = this.actions.getBankReleaseActions(page, bank, true)
		exp.feedbacks = this.feedback.getBankFeedbacks(page, bank, true)

		if (extras === true) {
			exp.version = this.registry.fileVersion
			exp.type = 'bank'

			exp.instances = {}

			for (let key in exp.actions) {
				let item = exp.actions[key]

				if (exp.instances[action.instance] === undefined) {
					if (this.instance[item.instance] !== undefined) {
						exp.instances[item.instance] = this.instance.getInstanceConfig(item.instance)
					}
				}
			}

			for (let key in exp.release_actions) {
				let item = exp.release_actions[key]

				if (exp.instances[item.instance] === undefined) {
					if (this.instance[item.instance] !== undefined) {
						exp.instances[item.instance] = this.instance.getInstanceConfig(item.instance)
					}
				}
			}

			for (let key in exp.feedbacks) {
				let item = exp.feedbacks[key]

				if (exp.instances[item.instance] === undefined) {
					if (this.instance[item.instance] !== undefined) {
						exp.instances[item.instance] = this.instance.getInstanceConfig(item.instance)
					}
				}
			}
		}

		this.debug('Exported config for bank ' + page + '.' + bank)

		// This should be removed in the future
		if (cb !== undefined &amp;&amp; typeof cb == 'function') {
			cb(exp)
		}

		return cb
	}

	exportOldConfig(page, bank) {
		var exp = {}

		exp.config = cloneDeep(old_config[page][bank])
		exp.instances = {}

		if (old_bank_actions[page] !== undefined) {
			exp.actions = cloneDeep(old_bank_actions[page][bank])
		}

		if (old_bank_release_actions[page] !== undefined) {
			exp.release_actions = cloneDeep(old_bank_release_actions[page][bank])
		}

		if (old_feedbacks[page] !== undefined) {
			exp.feedbacks = cloneDeep(old_feedbacks[page][bank])
		}

		return exp
	}

	getAll(clone = false) {
		let out

		if (this.config !== undefined) {
			if (clone === true) {
				out = cloneDeep(this.config)
			} else {
				out = this.config
			}
		}

		return out
	}

	getBank(page, bank, clone = false) {
		let out

		if (this.config[page] !== undefined &amp;&amp; this.config[page][bank] !== undefined) {
			if (clone === true) {
				out = cloneDeep(this.config[page][bank])
			} else {
				out = this.config[page][bank]
			}
		}

		return out
	}

	getBankStatus(page, bank) {
		return this.actions.getBankStatus(page, bank)
	}

	getBankWithFeedback(page, bank) {
		let out

		if (
			this.config[page] !== undefined &amp;&amp;
			this.config[page][bank] !== undefined &amp;&amp;
			this.config[page][bank].style !== undefined
		) {
			out = cloneDeep(this.config[page][bank])

			// Fetch feedback-overrides for bank
			let style = this.feedback.getBankStyle(page, bank)

			if (style !== undefined) {
				for (let key in style) {
					out[key] = style[key]
				}
			}
		}

		return out
	}

	getPage(page, clone = false) {
		let out

		if (this.config[page] !== undefined) {
			if (clone === true) {
				out = cloneDeep(this.config[page])
			} else {
				out = this.config[page]
			}
		}

		return out
	}

	getRunningActions(page, bank) {
		return this.actions.getRunningActions(page, bank)
	}

	importBank(page, bank, imp, cb) {
		this.resetBank(page, bank)

		if (imp.config === undefined) {
			// this should technically throw an exception
			imp.config = {}
		}

		if (imp.config.style !== undefined &amp;&amp; imp.config.style == 'text') {
			// v2.0.0: 'text' button style is now 'png'
			imp.config.style = 'png'
		}

		if (this.config[page] === undefined) {
			this.config[page] = {}
		}

		this.actions.importBank(page, bank, imp.actions, imp.release_actions)
		this.feedback.importBank(page, bank, imp.feedbacks)

		// TODO: Rename variable definitions
		this.config[page][bank] = imp.config

		this.graphics.invalidateBank(page, bank)
		this.system.emit('bank_update', this.config)

		this.db.setDirty()

		this.debug('Imported config to bank ' + page + '.' + bank)
		if (cb !== undefined &amp;&amp; typeof cb == 'function') {
			cb()
		}
	}

	loadDB() {
		let res = this.db.getKey('bank', {})

		if (res !== undefined) {
			this.config = res

			/* Fix pre-v1.1.0 and pre-v2.0.0 config for banks */
			for (var page in this.config) {
				for (var bank in this.config[page]) {
					if (
						this.config[page][bank].style !== undefined &amp;&amp;
						this.config[page][bank].style.match(/^bigtext|smalltext$/)
					) {
						this.config[page][bank].size = this.config[page][bank].style == 'smalltext' ? 'small' : 'large'
						this.config[page][bank].style = 'png'
					}

					if (this.config[page][bank].style !== undefined &amp;&amp; this.config[page][bank].style == 'text') {
						this.config[page][bank].style = 'png'
					}
				}
			}
		} else {
			for (var x = 1; x &lt;= 99; x++) {
				if (this.config[x] === undefined) {
					this.config[x] = {}

					for (var y = 1; y &lt;= global.MAX_BUTTONS; y++) {
						if (this.config[x][y] === undefined) {
							this.config[x][y] = {}
						}
					}
				}
			}

			this.db.setKey('page_config_version', BankController.CurrentVersion)
		}
	}

	moveBank(client, pagefrom, bankfrom, pageto, bankto) {
		if (pagefrom != pageto || bankfrom != bankto) {
			let exp = this.exportBank(pagefrom, bankfrom)
			this.importBank(pageto, bankto, exp)
			this.bankReset(pagefrom, bankfrom)
		}

		client.emit('bank_move:result', null, 'ok')
	}

	renameVariables(from, to) {
		for (var page in this.config) {
			for (var bank in this.config[page]) {
				if (this.config[page][bank].style !== undefined &amp;&amp; this.config[page][bank].text !== undefined) {
					this.system.emit('variable_rename_callback', this.config[page][bank].text, from, to, (result) => {
						if (this.config[page][bank].text !== result) {
							this.debug('rewrote ' + this.config[page][bank].text + ' to ' + result)
							this.config[page][bank].text = result
						}
					})
				}
			}
		}
	}

	resetBank(page, bank) {
		if (this.config[page] === undefined) {
			this.config[page] = {}
		}

		this.config[page][bank] = {}

		this.actions.resetBank(page, bank)
		this.feedback.resetBank(page, bank)

		this.actions.checkBankStatus(page, bank, false)
		this.feedback.checkBankStyle(page, bank, false)
		this.graphics.invalidateBank(page, bank)
		//this.system.emit('bank_update', this.config);
		this.system.emit('bank_style_changed', page, bank)
		this.debug('bank_reset()', page, bank)
	}

	setBankField(page, bank, key, val) {
		if (this.config[page] !== undefined &amp;&amp; this.config[page][bank] !== undefined) {
			this.config[page][bank][key] = val
			this.db.setKey('bank', this.config)
			//this.db.setDirty();
		}
	}

	setBankStyle(page, bank, style, cb) {
		if (this.config[page] === undefined) {
			this.config[page] = {}
		}

		// If there was an image, delete it
		try {
			fs.unlink(this.registry.cfgDir + '/banks/' + page + '_' + bank + '.png', () => {})
		} catch (e) {}

		if (style == 'none' || this.config[page][bank] === undefined || this.config[page][bank].style === undefined) {
			this.config[page][bank] = undefined
		}

		if (style == 'none') {
			//this.system.emit('bank_update', this.config, undefined);
			this.system.emit('graphics_bank_invalidate', page, bank)
			this.system.emit('bank_style_changed', page, bank)
			cb(undefined)
			return
		} else if (style == 'pageup') {
			this.system.emit('bank_reset', page, bank)
		} else if (style == 'pagenum') {
			this.system.emit('bank_reset', page, bank)
		} else if (style == 'pagedown') {
			this.system.emit('bank_reset', page, bank)
		}

		this.config[page][bank] = {
			style: style,
		}

		var fields = []
		if (this.fields[style] !== undefined) {
			fields = this.fields[style]
		}

		// Install default values
		for (var i = 0; i &lt; fields.length; ++i) {
			if (fields[i].default !== undefined) {
				this.config[page][bank][fields[i].id] = fields[i].default
			}
		}

		//this.system.emit('bank_update', this.config, fields);
		this.actions.checkBankStatus(page, bank, false)
		this.feedback.checkBankStatus(page, bank, false)
		this.graphics.invalidateBank(page, bank)
		this.system.emit('bank_style_changed', page, bank)

		if (cb !== undefined &amp;&amp; typeof cb == 'function') {
			cb(fields)
		}
	}

	updateBankField(page, bank, key, val) {
		this.config[page][bank][key] = val
		//this.system.emit('bank_update', this.config);
		this.graphics.invalidateBank(page, bank)
	}

	/*updateConfig(cfg) {
		this.debug('bank_update saving');
		this.config = cfg; // in case new reference
		this.db.setKey('bank', cfg );
		//this.system.emit('db_save');
	}*/

	upgrade15to32() {
		var old_config, old_bank_actions, old_bank_release_actions, old_feedbacks

		old_config = this.getAll(true)
		this.config = this.db.getKey('bank', {})

		old_bank_actions = this.actions.getActions(true)
		old_bank_release_actions = this.actions.getReleaseActions(true)
		old_feedbacks = this.feedback.getFeedback(true)

		if (old_bank_actions === undefined) {
			old_bank_actions = {}
		}
		if (old_bank_actions === undefined) {
			old_bank_actions = {}
		}

		for (var page = 1; page &lt;= 99; ++page) {
			if (this.config[page] === undefined) {
				this.config[page] = {}
			}

			// Reset
			for (var i = 0; i &lt; 32; ++i) {
				this.resetBank(page, i + 1)
			}

			// Add navigation keys
			this.importBank(page, 1, { config: { style: 'pageup' } })
			this.importBank(page, 9, { config: { style: 'pagenum' } })
			this.importBank(page, 17, { config: { style: 'pagedown' } })

			// Move keys around
			for (var b in old_config[page]) {
				var old = this.exportOldConfig(page, b)

				this.system.emit('import_bank', page, this.convertKey15to32(b - 1) + 1, old)
			}
		}

		this.db.setKey('bank', this.config)
		this.db.setKey('page_config_version', BankController.CurrentVersion)
	}

	variableChanged(label, variable) {
		for (var page in this.config) {
			for (var bank in this.config[page]) {
				var data = this.config[page][bank]
				var reg = new RegExp('\\$\\(' + label + ':' + variable + '\\)')

				if (data.text !== undefined &amp;&amp; data.text.match(reg)) {
					this.debug('variable changed in bank ' + page + '.' + bank)
					this.graphics.invalidateBank(page, bank)
				}
			}
		}
	}
}

exports = module.exports = BankController
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://bitfocus.io/images/topbar-logowhite.png" style="width: 147px; height: 24px">
    <div class="footer-text"> </div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
